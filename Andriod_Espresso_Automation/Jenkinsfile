// Jenkinsfile

pipeline {
    agent any

    environment {
        PATH = "${env.ANDROID_HOME}/cmdline-tools/latest/bin:${env.ANDROID_HOME}/emulator:${env.ANDROID_HOME}/platform-tools:${env.PATH}"
        GRADLE_WRAPPER   = ".\\gradlew.bat"
        AVD_NAME         = "ci_test_avd"
        PLATFORM_VERSION = "android-30"
    }

    stages {
        stage("Checkout Code") {
            steps {
                checkout scm
            }
        }

        stage("Clean Workspace") {
            steps {
                bat "%GRADLE_WRAPPER% clean"
            }
        }

        stage("Start Android Emulator") {
            steps {
                script {
                    echo "Creating Android Virtual Device (AVD)..."

                    bat """
                    echo no | avdmanager create avd ^
                      --name "%AVD_NAME%" ^
                      --package "system-images;${PLATFORM_VERSION};google_apis;x86_64" ^
                      --force
                    """

                    echo "Starting emulator..."

                    bat """
                    start /B emulator -avd %AVD_NAME% ^
                      -no-window -no-audio -no-boot-anim -port 5554
                    """

                    bat "adb wait-for-device"

                    echo "Emulator is online. Waiting for boot process to complete..."

                    rem Simple wait loop for Windows cmd
                    bat "adb shell while [ -z \\\"\\$(getprop sys.boot_completed)\\\" ]; do sleep 5; done"

                    bat "adb shell input keyevent 82"

                    echo "Emulator is ready."
                }
            }
        }

        stage("Run Espresso Tests") {
            steps {
                bat "%GRADLE_WRAPPER% connectedDebugAndroidTest --no-daemon"
            }
        }
    }

    post {
        always {
            script {
                echo "Publishing JUnit test results..."
                junit "app/build/outputs/androidTest-results/connected/**/*.xml"

                echo "Archiving build artifacts..."
                archiveArtifacts artifacts: "app/build/reports/androidTests/connected/index.html, app/build/outputs/apk/debug/*.apk", allowEmptyArchive: true

                echo "Shutting down emulator..."
                bat "adb emu kill || echo ."
            }
        }
        success {
            echo "Pipeline completed successfully."
        }
        failure {
            echo "Pipeline failed. Please review the logs and test reports."
        }
    }
}
