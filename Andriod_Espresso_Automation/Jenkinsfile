// Jenkinsfile

pipeline {
    // 1. Agent: Defines where the build runs. 'agent any' should be a Jenkins agent with Android SDK installed.
    agent any

    environment {
        // Assumes ANDROID_HOME is set in Jenkins global configuration.
        // Update PATH to include Android SDK tools for easier access in shell commands.
        PATH = "${env.ANDROID_HOME}/cmdline-tools/latest/bin:${env.ANDROID_HOME}/emulator:${env.ANDROID_HOME}/platform-tools:${env.PATH}"

        GRADLE_WRAPPER   = '.\\gradlew.bat'
        AVD_NAME         = 'ci_test_avd'
        PLATFORM_VERSION = 'android-30' // Target Android API Level for the emulator
    }

    stages {
        stage('Checkout Code') {
            steps {
                // Fetches the source code from the configured SCM (e.g., Git)
                checkout scm
            }
        }

        stage('Clean Workspace') {
            steps {
                // Use 'call' to properly execute the batch script on Windows.
                bat "call ${GRADLE_WRAPPER} clean"
            }
        }

        stage('Start Android Emulator') {
            steps {
                script {
                    echo "Creating Android Virtual Device (AVD)..."
                    // Create a new AVD, overwriting if it already exists.
                    // Using google_apis for access to Google Play Services, and x86_64 for better performance on CI servers.
                    bat "echo no | avdmanager create avd --name \"${AVD_NAME}\" --package \"system-images;${PLATFORM_VERSION};google_apis;x86_64\" --force"

                    echo "Starting emulator..."
                    // Start the emulator in the background without a UI, audio, or boot animation for faster startup.
                    // Use 'start /B' for background execution on Windows.
                    bat "start /B emulator -avd ${AVD_NAME} -no-window -no-audio -no-boot-anim -port 5554"

                    // Wait for the Android Debug Bridge (ADB) to see the device.
                    bat "adb wait-for-device"
                    echo "Emulator is online. Waiting for boot process to complete..."

                    // Use a retry block to robustly wait for the emulator to fully boot.
                    retry(count: 24, sleep: 5) { // Total wait time: 2 minutes
                        script {
                            def output = bat(script: 'adb shell getprop sys.boot_completed', returnStdout: true).trim()
                            if (output != '1') {
                                error "Emulator not booted yet. Current status: ${output}"
                            }
                        }
                    }

                    // Unlock the screen to ensure UI is accessible for tests.
                    bat "adb shell input keyevent 82"
                    
                    echo "Emulator is ready."
                }
            }
        }

        stage('Run Espresso Tests') {
            steps {
                // Execute instrumentation tests on the connected emulator.
                // Use 'call' and --no-daemon is recommended for CI environments.
                bat "call ${GRADLE_WRAPPER} connectedDebugAndroidTest --no-daemon"
            }
        }
    }

    // Post-build actions are executed after all stages have completed.
    post {
        always {
            script {
                echo "Publishing JUnit test results..."
                // Collect and publish test results. Allow empty results to prevent failure if tests are skipped.
                junit 'app/build/outputs/androidTest-results/connected/**/*.xml', allowEmptyResults: true

                echo "Archiving build artifacts..."
                // Archive the HTML test report and the generated APK for later inspection.
                archiveArtifacts artifacts: 'app/build/reports/androidTests/connected/index.html, app/build/outputs/apk/debug/*.apk', allowEmptyArchive: true

                echo "Shutting down emulator..."
                // Ensure the emulator is killed to free up resources on the agent.
                // Use '|| echo.' to prevent the build from failing if the emulator is already stopped.
                bat "adb emu kill || echo."
            }
        }
        success {
            echo "Pipeline completed successfully."
        }
        failure {
            echo "Pipeline failed. Please review the logs and test reports."
        }
    }
}
